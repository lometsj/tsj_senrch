<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- 添加Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .chat-container {
            max-width: 100%;  /* 铺满屏幕宽度 */
            margin: 20px 0;  /* 左右边距归零 */
            padding: 15px;
        }
        
        .bubble {
            position: relative;
            max-width: 100%;  /* 气泡至少占据屏幕一半（50%以上） */
            margin: 10px 20px;
            padding: 12px;
            border-radius: 8px;
            animation: fadeIn 0.3s;
        }
        
        .bubble-left {
            background: #d1f4d3;
            margin-right: auto;
        }
        
        .bubble-right {
            background: #e5f2ff;
            margin-left: auto;
        }
        
        /* 调整小三角方向 */
        .bubble-left::before {
            left: auto;
            right: -10px;
            border-width: 8px 0 8px 10px;
            border-color: transparent transparent transparent #d1f4d3;
        }
        
        .bubble-right::before {
            right: -10px;
            left: auto;
            border-width: 8px 10px 8px 0;
            border-color: transparent #e5f2fd transparent transparent;
        }
        
        /* QQ气泡小三角 */
        /* 添加气泡小三角样式 */
        .bubble-left::before, .bubble-right::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .bubble-left::before {
            left: -10px;
            top: 10px;
            border-width: 8px 10px 8px 0;
            border-color: transparent #d1f4d3 transparent transparent;
        }
        
        .bubble-right::before {
            right: -10px;
            top: 10px;
            border-width: 8px 0 8px 10px;
            border-color: transparent transparent transparent #e3f2fd;
        }
        
        /* 确保气泡有相对定位 */
        .bubble {
            position: relative;
            max-width: 100%;  /* 保持最大宽度为父容器100% */
            width: auto;  /* 自动填充可用空间 */
        }
        
        .bubble-right {
            margin-left: 20px;  /* 调整左侧边距为固定值 */
            margin-right: 20px;  /* 右侧边距保持一致 */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 在CSS部分添加 */
        .bubble {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 添加角色头部样式 */
        .message-container {
            display: flex;
            flex-direction: column;
            margin: 15px 0;
        }
        
        .role-header {
            margin: 0 20px 5px 20px;
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
        }
        .role-header i {
            margin-right: 8px;
            font-size: 1.2em;
        }
    </style>
    <!-- Prism高亮功能已移除，添加基本代码样式 -->
    <style>
        pre {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            overflow: auto;
        }
        
        code {
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
            tab-size: 4;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">  <!-- 将container改为container-fluid -->
        <h2 class="mb-4">TSJ数据分析展示</h2>
        <div class="d-flex justify-content-between mb-1">
            <div class="d-flex flex-grow-1">
                <input type="file" id="jsonUpload" class="form-control p-1" accept=".json">
                <button id="filterBtn" class="btn btn-outline-primary ms-2" style="white-space: nowrap;">仅显示问题信息</button>
            </div>
            <div class="d-flex align-items-center ms-2">
                <label for="pageSizeSelect" class="me-2 mb-0">每页显示:</label>
                <select id="pageSizeSelect" class="form-select form-select-sm" style="width: 80px;">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="搜索问题类型或上下文...">
                <button id="searchBtn" class="btn btn-outline-secondary">搜索</button>
                <button id="clearSearchBtn" class="btn btn-outline-danger">清除</button>
            </div>
        </div>
        <div id="performanceInfo" class="alert alert-info mb-3 d-none">
            <small>性能信息: <span id="performanceMetrics"></span></small>
        </div>
        <div id="chatContainer" class="chat-container"></div>
    </div>
    <script>
        let currentData = [];
        let filteredData = [];
        let showOnlyProblem = false;
        let pageSize = 20; // 每页显示的记录数
        let currentPage = 1; // 当前页码
        let loadingIndicator;
        let searchTerm = '';
        let performanceMetrics = {};
        
        // 创建加载指示器
        function createLoadingIndicator() {
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'text-center my-4';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在处理数据，请稍候...</p>
                `;
            }
            return loadingIndicator;
        }
        
        // 性能监控函数
        function recordPerformance(action, startTime) {
            const duration = performance.now() - startTime;
            performanceMetrics[action] = duration.toFixed(2) + 'ms';
            updatePerformanceDisplay();
        }
        
        // 更新性能显示
        function updatePerformanceDisplay() {
            const metricsEl = document.getElementById('performanceMetrics');
            const infoEl = document.getElementById('performanceInfo');
            
            if (Object.keys(performanceMetrics).length > 0) {
                let metricsText = '';
                for (const [action, time] of Object.entries(performanceMetrics)) {
                    metricsText += `${action}: ${time} | `;
                }
                metricsEl.textContent = metricsText.slice(0, -3); // 移除最后的 ' | '
                infoEl.classList.remove('d-none');
            }
        }

        document.getElementById('jsonUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 显示加载指示器
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            container.appendChild(createLoadingIndicator());
            
            // 记录开始时间
            const startTime = performance.now();
            
            // 使用 Worker 在后台线程解析 JSON
            if (window.Worker) {
                const jsonWorker = new Worker(URL.createObjectURL(new Blob([`
                    self.onmessage = function(e) {
                        try {
                            const jsonData = JSON.parse(e.data);
                            self.postMessage({success: true, data: jsonData});
                        } catch (error) {
                            self.postMessage({success: false, error: error.message});
                        }
                    };
                `], {type: 'application/javascript'})));
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    jsonWorker.postMessage(event.target.result);
                };
                
                jsonWorker.onmessage = function(e) {
                    if (e.data.success) {
                        currentData = e.data.data;
                        searchTerm = ''; // 重置搜索
                        document.getElementById('searchInput').value = '';
                        currentPage = 1; // 重置页码
                        recordPerformance('JSON解析', startTime);
                        applyFiltersAndSearch();
                    } else {
                        alert('文件解析错误: ' + e.data.error);
                        container.innerHTML = '';
                    }
                    jsonWorker.terminate();
                };
                
                reader.readAsText(file);
            } else {
                // 回退到主线程解析（对于不支持 Worker 的浏览器）
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        currentData = jsonData;
                        searchTerm = ''; // 重置搜索
                        document.getElementById('searchInput').value = '';
                        currentPage = 1; // 重置页码
                        recordPerformance('JSON解析', startTime);
                        applyFiltersAndSearch();
                    } catch (error) {
                        alert('文件解析错误: ' + error.message);
                        container.innerHTML = '';
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // 页面大小选择器事件
        document.getElementById('pageSizeSelect').addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 1; // 重置到第一页
            applyFiltersAndSearch();
        });
        
        // 搜索按钮事件
        document.getElementById('searchBtn').addEventListener('click', function() {
            searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            currentPage = 1; // 重置到第一页
            applyFiltersAndSearch();
        });
        
        // 搜索输入框回车事件
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchTerm = this.value.trim().toLowerCase();
                currentPage = 1; // 重置到第一页
                applyFiltersAndSearch();
            }
        });
        
        // 清除搜索按钮事件
        document.getElementById('clearSearchBtn').addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            currentPage = 1; // 重置到第一页
            applyFiltersAndSearch();
        });
        
        // 应用过滤器和搜索
        function applyFiltersAndSearch() {
            const startTime = performance.now();
            
            // 应用问题过滤
            let result = showOnlyProblem ? 
                currentData.filter(item => item.has_problem_info) : 
                [...currentData];
            
            // 应用搜索
            if (searchTerm != '') {
                result = result.filter(item => {
                    // 搜索问题类型和上下文
                    if (item.has_problem_info) {
                        const problemType = item.problem_info.problem_type.toLowerCase();
                        const context = String(item.problem_info.context).toLowerCase();
                        return problemType.includes(searchTerm) || context.includes(searchTerm);
                    }
                    return false;
                });
            }
            
            filteredData = result;
            recordPerformance('过滤和搜索', startTime);
            displayData();
        }

        document.getElementById('filterBtn').addEventListener('click', function() {
            showOnlyProblem = !showOnlyProblem;
            this.textContent = showOnlyProblem ? '显示全部' : '仅显示问题信息';
            currentPage = 1; // 重置页码
            applyFiltersAndSearch();
        });
        
        // 添加防抖函数
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 修改气泡生成部分 - 优化版本，支持分页和延迟渲染
        function displayData() {
            const startTime = performance.now();
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            
            // 如果没有数据
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="alert alert-info">没有找到符合条件的数据</div>';
                return;
            }
            
            // 计算总页数
            const totalPages = Math.ceil(filteredData.length / pageSize);
            
            // 确保当前页在有效范围内
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            // 计算当前页的数据范围
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const currentPageData = filteredData.slice(startIndex, endIndex);
            
            // 创建分页信息
            const paginationInfo = document.createElement('div');
            paginationInfo.className = 'alert alert-light d-flex justify-content-between align-items-center';
            paginationInfo.innerHTML = `
                <span>显示 ${startIndex + 1} 到 ${endIndex} 条，共 ${filteredData.length} 条记录</span>
                <div>
                    <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary me-2" ${currentPage === 1 ? 'disabled' : ''}>
                        <i class="bi bi-chevron-left"></i> 上一页
                    </button>
                    <span class="mx-2">第 ${currentPage} / ${totalPages} 页</span>
                    <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary ms-2" ${currentPage === totalPages ? 'disabled' : ''}>
                        下一页 <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            `;
            container.appendChild(paginationInfo);
            
            // 添加分页事件监听
            document.getElementById('prevPageBtn')?.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    displayData();
                    // 滚动到顶部
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
            
            document.getElementById('nextPageBtn')?.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayData();
                    // 滚动到顶部
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
            
            // 使用文档片段减少DOM重排
            const fragment = document.createDocumentFragment();
            
            // 一次性渲染当前页面的所有数据
            function renderAllItems() {
                // 遍历当前页的所有数据
                for (let i = 0; i < currentPageData.length; i++) {
                    const item = currentPageData[i];
                    
                    // 创建折叠面板
                    const panel = document.createElement('div');
                    panel.className = 'card mb-3';
                    
                    // 面板标题 - 使用模板字符串一次性创建
                    const panelHeader = document.createElement('div');
                    panelHeader.className = 'card-header d-flex justify-content-between align-items-center';
                    
                    if (item.has_problem_info && item.problem_info!=null) {
                        panelHeader.innerHTML = `
                            <span>
                                <strong>${item.problem_info.problem_type}</strong> - 记录 #${item.problem_info.context}
                                <span class="badge bg-danger ms-2">问题</span>
                            </span>
                            <button class="btn btn-sm btn-outline-secondary toggle-btn">展开</button>
                        `;
                    } else {
                        panelHeader.innerHTML = `
                            <span>
                                <span class="badge bg-success ms-2">安全</span>
                            </span>
                            <button class="btn btn-sm btn-outline-secondary toggle-btn">展开</button>
                        `;
                    }
                    
                    // 面板内容 - 延迟创建，只有在展开时才渲染内容
                    const panelBody = document.createElement('div');
                    panelBody.className = 'card-body collapse';
                    panelBody.dataset.loaded = 'false'; // 标记内容是否已加载
                    
                    // 存储项目数据，以便后续延迟加载
                    panelBody.dataset.itemData = JSON.stringify(item);
                    
                    // 添加点击事件 - 使用事件委托减少事件监听器数量
                    panelHeader.addEventListener('click', function() {
                        const body = this.nextElementSibling;
                        body.classList.toggle('show');
                        
                        const toggleBtn = this.querySelector('.toggle-btn');
                        toggleBtn.textContent = body.classList.contains('show') ? '折叠' : '展开';
                        
                        // 如果展开且内容未加载，则加载内容
                        if (body.classList.contains('show') && body.dataset.loaded === 'false') {
                            loadPanelContent(body);
                        }
                    });
                    
                    // 防止按钮点击事件冒泡
                    const toggleBtn = panelHeader.querySelector('.toggle-btn');
                    toggleBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const body = this.closest('.card-header').nextElementSibling;
                        body.classList.toggle('show');
                        this.textContent = body.classList.contains('show') ? '折叠' : '展开';
                        
                        // 如果展开且内容未加载，则加载内容
                        if (body.classList.contains('show') && body.dataset.loaded === 'false') {
                            loadPanelContent(body);
                        }
                    });
                    
                    panel.appendChild(panelHeader);
                    panel.appendChild(panelBody);
                    fragment.appendChild(panel);
                }
                
                // 代码高亮功能已移除
                // setTimeout(() => Prism.highlightAll(), 0);
            }
            
            // 延迟加载面板内容
            function loadPanelContent(panelBody) {
                try {
                    const item = JSON.parse(panelBody.dataset.itemData);
                    
                    // 显示对话气泡
                    if (item.conversation && Array.isArray(item.conversation)) {
                        const conversationFragment = document.createDocumentFragment();
                        
                        item.conversation.forEach(msg => {
                            // 创建消息容器
                            const messageContainer = document.createElement('div');
                            messageContainer.className = 'message-container';
                            
                            // 创建角色头部
                            const roleHeader = document.createElement('div');
                            roleHeader.className = 'role-header';
                            
                            // 创建气泡元素
                            const bubble = document.createElement('div');
                            
                            // 设置气泡样式
                            if (msg.role === 'user') {
                                bubble.className = 'bubble bubble-right';
                                roleHeader.innerHTML = `<i class="bi bi-person-fill"></i><span>用户</span>`;
                                messageContainer.style.justifyContent = 'flex-end';
                            } else if (msg.role === 'assistant') {
                                bubble.className = 'bubble bubble-left';
                                roleHeader.innerHTML = `<i class="bi bi-robot"></i><span>助手</span>`;
                                messageContainer.style.justifyContent = 'flex-start';
                            }
                            
                            // 添加内容 - 移除代码高亮
                            bubble.innerHTML = `<div><pre><code>${msg.content}</code></pre></div>`;
                            
                            // 组装元素
                            messageContainer.appendChild(roleHeader);
                            messageContainer.appendChild(bubble);
                            conversationFragment.appendChild(messageContainer);
                        });
                        
                        panelBody.appendChild(conversationFragment);
                    }
                    
                    // 显示其他信息
                    const table = document.createElement('table');
                    table.className = 'table table-bordered table-sm mt-3';
                    
                    let tableHtml = '<thead><tr><th>字段</th><th>值</th></tr></thead><tbody>';
                    
                    // 添加问题信息详情
                    if (item.has_problem_info && item.problem_info!=null) {
                        tableHtml += `<tr class="table-danger">
                            <td>问题信息详情</td>
                            <td>类型: ${item.problem_info.problem_type}<br>
                            上下文: ${item.problem_info.context}</td>
                        </tr>`;
                    }
                    
                    tableHtml += '</tbody>';
                    table.innerHTML = tableHtml;
                    panelBody.appendChild(table);
                    
                    // 标记为已加载
                    panelBody.dataset.loaded = 'true';
                    
                    // 代码高亮功能已移除
                    // setTimeout(() => Prism.highlightElement(panelBody.querySelector('code')), 0);
                    
                } catch (error) {
                    console.error('加载面板内容失败:', error);
                    panelBody.innerHTML = '<div class="alert alert-danger">加载内容失败</div>';
                }
            }
            
            // 一次性渲染所有数据
            renderAllItems();
            
            // 将文档片段添加到容器
            container.appendChild(fragment);
            
            // 添加底部分页控制器
            const bottomPagination = paginationInfo.cloneNode(true);
            bottomPagination.className += ' mt-3';
            container.appendChild(bottomPagination);
            
            // 添加底部分页事件监听
            bottomPagination.querySelector('#prevPageBtn')?.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    displayData();
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
            
            bottomPagination.querySelector('#nextPageBtn')?.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayData();
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
            
            // 记录渲染性能
            recordPerformance('页面渲染', startTime);
        }
    </script>
</body>
</html>